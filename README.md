# McAuthz
A library that allows using policy based rules for authorization in asp.net core. 

## Kinds of Authorization
Web api requests can be evaluated by policy in two ways: by principal and http method (GET, POST, etc)
or by principal and resource type. 

```

                       [ Authorization Middleware ]    [            Endpoint Middleware           ]
__________             ____________________________    ______________    __________________________
|        |             |   Authorization Policy   |    | Controller |    | Resource Authorization |
| Client | Request  -> | Inspect: Identity/Method | -> |            | -> |                        |
|        | Response <- |                          | <- |            | <- |    Inspect objects     |
‾‾‾‾‾‾‾‾‾‾             ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾    ‾‾‾‾‾‾‾‾‾‾‾‾‾‾    ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾
                       [     Request Policies     ]    [             Resource Policies            ]
```
### Policies
Policies are evaluated at runtime as predicates created from expression trees. If that's new to you,
think of it as a Linq query that's generated at runtime. These predicates are generated by the McRule
libary, see that package's Readme for information on the supported pattern matching grammar. 

The general idea is that these predicates inspect a property on an object and return true or false.
RequstPolicy and ResourcePolicy are the two general types and contain a List<Requirement> that encodes
the rules. 


ResourcePolicies include a TargetType property to determine scope. Requirements are usually
a list of PropertyRequirements, as they evaluate against the properties of a model object.

If the simple language in this readme makes seem like a bot wrote this, that's not it. Usage 
of the library was intended to be simple, so the parts a developer or operator touches are
simple.

McAttributes is the example app used while developing this library. It comes from something else
I needed for work but is just a simple web api + razor pages app with a SQLite database. Test data
is included.

Usage of the library assumes your application implementes IRuleProvider. There's a naive example
in Program.cs of the example app, but you'll want to implement your own to load policies as data.
You'll also want to examine service setup and middleware usings. Look to SayController.cs and
SayKVController.cs for examples of ResourcePolicy usage.

### Request Policies
These include a Route and Action property, which is used to determine whether
it should be included for evaluation at authorization time. Requirement types for these policies
generaly includes ClaimRequirement and RoleRequirements, both of these evaluate against the
ClaimsPrincipal. RequestPolicy failure short circuits the pipeline and returns a 401 Unauthorized response.

### Resource Policies
Resource policies evaluate at the middleware endpoint as part of the controller's processing. These policies are selected by inferring tyoe of the model being processed by a controller. The idea was inspired by the [Resource Based Authorization](https://andrewlock.net/resource-specific-authorisation-in-asp-net-core/) articles that became part of Andrew Lock's book ASP.NET Core In Action. It's great, go buy it.

